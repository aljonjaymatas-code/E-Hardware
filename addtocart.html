<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Your Cart</title>
  <link rel="stylesheet" href="addtocart.css" />

</head>
<body>
  <div class="container">
    <h1>Your Cart</h1>
    <div class="cart-layout">
      <div id="cart-root" class="cart-list"></div>
      <aside class="summary" id="cart-summary">
        <h3>Order Summary</h3>
        <div class="row"><span>Items</span><span id="summary-items"></span></div>
        <div class="row"><span>Subtotal</span><span id="summary-sub"></span></div>
        <div class="row"><span>Shipping</span><span id="summary-ship"></span></div>
        <div class="row total"><span>Total</span><span id="summary-total"></span></div>
        <div class="actions"><button id="checkout" class="btn-primary">Checkout</button><button id="clear-cart" class="btn-ghost">Clear Cart</button></div>
      </aside>
    </div>
  <div style="margin-top:18px"><a href="index.html#Product" class="continue-btn">Continue shopping</a></div>
  </div>

  <script>
    (function(){
      const STORAGE_KEY = 'ehw_cart_v1';
      const UPDATE_KEY = 'ehw_cart_v1_last_update';
      function readCart(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }catch(e){ return {}; } }
      function writeCart(c){ 
        try{ 
          // Clean the cart object before saving - remove items with qty <= 0
          const cleanCart = {};
          Object.keys(c).forEach(key => {
            if (c[key] && c[key].qty > 0) {
              cleanCart[key] = c[key];
            }
          });
          
          localStorage.setItem(STORAGE_KEY, JSON.stringify(cleanCart)); 
          localStorage.setItem(UPDATE_KEY, Date.now());
          
          // Dispatch storage event for cross-tab sync
          window.dispatchEvent(new StorageEvent('storage', {
            key: STORAGE_KEY,
            newValue: JSON.stringify(cleanCart)
          }));
          
          // Update cart indicator if it exists
          updateCartIndicator();
        }catch(e){ 
          console.warn('Failed to write cart:', e);
        } 
      }

      // Update cart indicator in header
      function updateCartIndicator() {
        const cart = readCart();
        // Only count items with qty > 0
        const itemCount = Object.values(cart)
          .filter(item => item && item.qty > 0)
          .reduce((sum, item) => sum + item.qty, 0);
        const indicator = document.querySelector('.cart-indicator');
        if (indicator) {
          if (itemCount > 0) {
            indicator.textContent = itemCount;
            indicator.style.display = 'flex';
          } else {
            indicator.textContent = '';
            indicator.style.display = 'none';
          }
        }
      }

      const root = document.getElementById('cart-root');
      const summaryItems = document.getElementById('summary-items');
      const summarySub = document.getElementById('summary-sub');
      const summaryShip = document.getElementById('summary-ship');
      const summaryTotal = document.getElementById('summary-total');

      function money(n){ return '₱' + (Number(n)||0).toLocaleString(); }

      function calcTotals(cart){
        // Filter out invalid items and items with 0 quantity
        const items = Object.values(cart).filter(i => i && typeof i.price === 'number' && i.qty > 0);
        const itemCount = items.reduce((s,i)=>s + i.qty, 0);
        const subtotal = items.reduce((s,i)=>s + (i.price * i.qty), 0);
        const shipping = itemCount ? 120 : 0; // flat shipping for example
        const total = subtotal + shipping;
        return { itemCount, subtotal, shipping, total };
      }

      function render(){
        const cart = readCart();
        const keys = Object.keys(cart);
        if(keys.length === 0){
          root.innerHTML = '<div class="empty">Your cart is empty.</div>';
          summaryItems.textContent = '0'; summarySub.textContent = '₱0'; summaryShip.textContent = '₱0'; summaryTotal.textContent = '₱0';
          return;
        }

        const frag = document.createDocumentFragment();
        
        // Sort keys to ensure consistent display order
        keys.sort().forEach(k => {
          const it = cart[k];
          if (!it || typeof it.price !== 'number') return; // skip invalid items
          
          const div = document.createElement('div');
          const displayPrice = '₱' + it.price.toLocaleString(); // Format stored numeric price
          const itemTotal = it.price * (it.qty || 1);           // Compute subtotal per item
  
  div.className = 'cart-item';
  div.innerHTML = `
    <img src="${it.image || 'image/e12.webp'}" alt="${it.name}">
    <div class="item-meta">
      <h4>${it.name}</h4>
      <div class="price">Price: ${displayPrice}</div>
      <div class="price">Subtotal: ₱${itemTotal.toLocaleString()}</div>
      <div class="qty-controls">
        <button class="dec" data-id="${k}">-</button>
        <div class="count">${it.qty}</div>
        <button class="inc" data-id="${k}">+</button>
        <button class="remove" data-id="${k}">Remove</button>
      </div>
    </div>
  `;
  
  frag.appendChild(div);
});

        root.innerHTML = '';
        root.appendChild(frag);

        // handlers
        root.querySelectorAll('button.remove').forEach(btn=> btn.addEventListener('click', function(){
          const id = this.getAttribute('data-id'); 
          const cart = readCart(); 
          delete cart[id]; 
          writeCart(cart); 
          render();
          updateCartIndicator(); // Update indicator after removal
        }));

        root.querySelectorAll('button.inc').forEach(btn=> btn.addEventListener('click', function(){
          const id = this.getAttribute('data-id'); 
          const cart = readCart(); 
          if(!cart[id]) return; 
          cart[id].qty = (cart[id].qty||0) + 1; 
          writeCart(cart); 
          render();
          updateCartIndicator(); // Update indicator after increment
        }));

        root.querySelectorAll('button.dec').forEach(btn=> btn.addEventListener('click', function(){
          const id = this.getAttribute('data-id'); 
          const cart = readCart(); 
          if(!cart[id]) return; 

          // Only decrease if quantity is greater than 1
          if (cart[id].qty > 1) {
            cart[id].qty -= 1;

            
            writeCart(cart); 
            render();
            updateCartIndicator();
          }
        }));

        // update summary
        const t = calcTotals(cart);
        summaryItems.textContent = t.itemCount;
        summarySub.textContent = money(t.subtotal);
        summaryShip.textContent = money(t.shipping);
        summaryTotal.textContent = money(t.total);
      }

      document.getElementById('clear-cart').addEventListener('click', function(){
        if(!confirm('Clear all items from the cart?')) return; 
        writeCart({}); 
        render();
        updateCartIndicator(); // Update indicator after clearing cart
      });

      document.getElementById('checkout').addEventListener('click', function(){
        if(!Object.keys(readCart()).length){ alert('Your cart is empty'); return; }
        alert('Proceeding to checkout (demo)');
      });

      // Listen for storage changes from other tabs
      window.addEventListener('storage', function(e) {
        if (e.key === STORAGE_KEY) {
          render();
          updateCartIndicator();
        }
      });

      // Clean up any invalid cart data on page load
      const initialCart = readCart();
      writeCart(initialCart); // This will clean out any invalid items

      // initial render and indicator update
      render();
      updateCartIndicator();
    })();
  </script>
</body>
</html>